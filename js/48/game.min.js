var isFullscreen=false;
var isGameRunning=false;
var gameLayer=document.querySelector("#game-layer");
var g=document.querySelector("#game-layer");

function adBlockIsEnabled(){
    if(typeof adsAreWorking=="undefined"){
        return true
    }
    return false
}
if (g.dataset.type==="link"){
    startGameInNewWindow()
}

if(g.dataset.type==="iframe"){
    if(isMobileDevice()){
        document.getElementById("play-game").addEventListener("click",startGame)//OnMobile)
    }else{
        if(g.dataset.skipplay==="1"&&adBlockIsEnabled()===false){
            setTimeout(function(){
                startGame()
            }, 1)
        }else{
            if(g.dataset.preroll==="yes"){document.getElementById("play-game").addEventListener("click",startPrerollOnDesktop)

            }else{document.getElementById("play-game").addEventListener("click",startGame)

            }
        }
    }
}

if(adBlockIsEnabled()&&g.dataset.abinfo!=0){
    const tooltip=document.getElementById("tooltip-text");
    const gamebox=document.getElementById("game_box");
    tooltip.innerHTML=tooltip.dataset.txt;
    gamebox.addEventListener("mouseover",function(){
        tooltip.style.display="block"
    });
    gamebox.addEventListener("mouseout",function(){
        tooltip.style.display="none"
    });
    if(g.dataset.abinfo==="2"){
        const playbutton=document.getElementById("play-game");
        playbutton.style.display="none"
    }
}


function startGameInNewWindow(){
    document.getElementById("play-game").addEventListener("click",function(){
        window.open(g.dataset.src,"_blank").focus()
    });
}

function startGameOnMobile(){
    if(isGameRunning){
        g.style.display="flex";
        openBrowserFullscreen()
    }else{
        console.log('here')
        prepareGameLayer();
        showIframeOnMobile();
        openBrowserFullscreen();
        addFullscreenCloseListener();
        isGameRunning=true
    }
}

function startGame(){
    showIframe();
    console.log("Game started ..")
}


function startPrerollOnDesktop(){
    document.getElementById("game_frame").innerHTML="";
    if(typeof showPreRoll==="function"){
        showPreRoll()
    }else{
        startGame()
    }
}

function goFullScreen(){
    preventScrolling();
    var a=document.querySelector("#div_iframe");
    a.style.position="fixed";
    a.style.zIndex="3";
    a.style.top="0";
    a.style.left="0";
    showCloseButton()
}

var icon_fullscreen=document.querySelector("#icon_fullscreen");
if(icon_fullscreen){
    icon_fullscreen.addEventListener("click",goFullScreen)
}

function endFullScreen(){
    activateScrolling();
    var b=document.querySelector("#div_iframe");
    b.style.position="relative";
    b.style.zIndex="1";
    var a=document.querySelector("#close_button");
    a.style.display="none"
}

var cb=document.querySelector("#close_button");
if(cb){
    cb.addEventListener("click",endFullScreen)
}

function addFullscreenCloseListener(){
    document.addEventListener("fullscreenchange",fullscreenExitHandler,false);
    document.addEventListener("mozfullscreenchange",fullscreenExitHandler,false);
    document.addEventListener("MSFullscreenChange",fullscreenExitHandler,false);
    document.addEventListener("webkitfullscreenchange",fullscreenExitHandler,false)
}

function prepareGameLayer(){
    // console.log(g.st)
    g.style.height="100%";
    g.style.width="100%";
    g.style.top="0px";
    g.style.left="0px";
    g.style.position="fixed";
    g.style.zIndex="4";
    g.style.display="flex"
}

function hideGameLayer(){
    g.style.display="none"
}

function showIframeOnMobile(){
    if(g.dataset.sandbox){
        var a=' sandbox="'+g.dataset.sandbox+'"'
    }else{
        var a=""
    }
    height="100%";
    width="100%";
    g.innerHTML='<div id="div_iframe"><iframe src="'+g.dataset.src+'" id="iframe" marginwidth="0" marginheight="0" hspace="0" vspace="0" frameborder="0" scrolling="'+g.dataset.scrolling+'" width="100vw" height="100vh"'+a+' allowfullscreen="true" webkitallowfullscreen="true" mozallowfullscreen="true" msallowfullscreen="true"></iframe></div>';
    document.querySelector("#iframe").focus()
}

function showIframe(){
    var d=document.querySelector("#game_frame");
    var b=document.querySelector("#game_tools");
    b.style.visibility="visible";
    if(g.dataset.sandbox){
        var f=' sandbox="'+g.dataset.sandbox+'"'
    }else{
        var f=""
    }if(g.dataset.allow){
        var h=' allow="'+g.dataset.allow+'"'
    }else{
        var h=""
    }
    var a=g.dataset.height;
    var e=g.dataset.width;
    if(g.dataset.width>window.innerWidth){
        var e=window.innerWidth
    }else{
        var e=g.dataset.width
    }
    a="100%";
    e="100%";
    var c='<div id="div_iframe"><iframe src="'+g.dataset.src+'" id="iframe" marginwidth="0" marginheight="0" hspace="0" vspace="0" frameborder="0" scrolling="'+g.dataset.scrolling+'" width="'+e+'" height="'+a+'"'+f+h+' allowfullscreen="true" webkitallowfullscreen="true" mozallowfullscreen="true" msallowfullscreen="true"></iframe></div>';
    
    if(g.dataset.intro!="0"){
        showIntro(g.dataset.intro);
        setTimeout(function(){
            d.innerHTML=c
        },
        3000)
    }else{
        d.innerHTML=c
    }
    document.querySelector("#iframe").focus()
}




function showIntro(b){
    var a=document.querySelector("#game_frame");
    if(b==="1"){
        a.innerHTML='<div id="div_iframe"><iframe src="/thumbnail/intro/glitch/index.html" id="iframe" marginwidth="0" marginheight="0" hspace="0" vspace="0" frameborder="0" width="100%" height="100%" allowfullscreen="true" webkitallowfullscreen="true" mozallowfullscreen="true" msallowfullscreen="true"></iframe></div>'}else{if(b==="2"){a.innerHTML='<div id="div_iframe"><iframe src="/thumbnail/intro/ntflx/index.html" id="iframe" marginwidth="0" marginheight="0" hspace="0" vspace="0" frameborder="0" width="100%" height="100%" allowfullscreen="true" webkitallowfullscreen="true" mozallowfullscreen="true" msallowfullscreen="true"></iframe></div>'

        }
    }
}


function showCloseButton(){
    var d=document.getElementById("close_button_txt");
    var a=document.getElementById("close_button");
    a.style.display="inline-block";
    d.style.visibility="visible";
    setTimeout(function(){
        d.style.visibility="hidden"
    }, 5000);

    a.onmouseover=function(){
        d.style.visibility="visible"
    };
    a.onmouseout=function(){
        d.style.visibility="hidden"
    }
}


function hideCloseButton(){
    const a=document.getElementById("close_button");
    a.style.display="none"
}

function openBrowserFullscreen(){
    var a=document.getElementById("div_iframe");
    if(a.requestFullscreen){
        a.requestFullscreen()
    }else{
        if(a.webkitRequestFullscreen){
            a.webkitRequestFullscreen()
        }else{
            if(a.msRequestFullscreen){
            a.msRequestFullscreen()
            }
        }
    }
    isFullscreen=true;
}

function closeBrowserFullscreen(){
    console.log(1);
    if(document.exitFullscreen){
        document.exitFullscreen()
    }else{
        if(document.webkitExitFullscreen){
            document.webkitExitFullscreen()
        }else{
            if(document.msExitFullscreen){
                document.msExitFullscreen()
            }
        }
    }
    isFullscreen=false
}

function fullscreenExitHandler(){
    if(isFullscreen){
        if(document.webkitIsFullScreen===false){
            hideGameLayer()
        }else{
            if(document.mozFullScreen===false){
                hideGameLayer()
            }else{
                if(document.msFullscreenElement===false){
                    hideGameLayer()
                }
            }
        }
    }
}

function loadJSON(c,b){
    var a=new XMLHttpRequest();
    a.overrideMimeType("application/json");
    a.open("GET",b,true);
    a.onreadystatechange=function(){
        if(a.readyState===4&&a.status===200){
            c(a.responseText)
        }
    };
    
    a.send(null)
}

function visVote(a){
    var b=JSON.parse(a);
    vcounter=document.querySelectorAll(".rating-count");
    vcounter[0].innerHTML=b.votes;
    if(vcounter[1]){
        vcounter[1].innerHTML=b.votes
    }
    vrating=document.querySelectorAll(".rating");
    vrating[0].innerHTML=b.rating;
    if(vrating[1]){
        vrating[1].innerHTML=b.rating
    }
}

function vote(a,b){
    loadJSON(visVote,"/div/vote.php?v="+a+"&g="+b)
}

function unvote(a,b){
    loadJSON(visVote,"/div/vote.php?unvote=1&v="+a+"&g="+b)
}

var voted=false;
const c_default="#a0a0a0";
const c_active="#ffffff";
const thumbs=document.querySelector(".thumbs");
const v_yes=document.querySelector("#t-up");
const v_no=document.querySelector("#t-down");
const v_yes_big=document.querySelector("#t-up-big");
const v_no_big=document.querySelector("#t-down-big");

function setUpVoting(){
    const a=g.dataset.id;
    if(thumbs.dataset.voted==="like"){
        voteSetLike()
    }
    if(thumbs.dataset.voted==="dislike"){
        voteSetDislike()
    }
    v_yes.addEventListener("click",function(){
        if(!voted){
            vote("1",a);
            voteSetLike()
        }else{
            if(voted==="like"){
                unvote("1",a)
            }else{unvote("0",a)
            }
            voteSetDefault()
        }
    });

    v_no.addEventListener("click",function(){
        if(!voted){
            vote("0",a);
            voteSetDislike()
        }else{
            if(voted==="dislike"){
                unvote("0",a)
            }else{
                unvote("1",a)
            }
            voteSetDefault()
        }
    });
    
    v_yes_big.addEventListener("click",function(){
        if(!voted){
            vote("1",a);
            voteSetLike()
        }else{
            if(voted==="like"){
                unvote("1",a)
            }else{
                unvote("0",a)
            }
            voteSetDefault()
        }
    });
    
    v_no_big.addEventListener("click",function(){
        if(!voted){
            vote("0",a);
            voteSetDislike()
        }else{
            if(voted==="dislike"){
                unvote("0",a)
            }else{
                unvote("1",a)
            }
            voteSetDefault()
        }
    });
}


function voteSetDefault(){
    v_yes.style.fill=c_default;
    v_no.style.fill=c_default;
    v_yes_big.style.fill=c_default;
    v_no_big.style.fill=c_default;
    voted=false
}

function voteSetLike(){
    v_no.style.fill=c_default;
    v_yes.style.fill=c_active;
    v_no_big.style.fill=c_default;
    v_yes_big.style.fill=c_active;
    voted="like"
}

function voteSetDislike(){
    v_no.style.fill=c_active;
    v_yes.style.fill=c_default;
    v_no_big.style.fill=c_active;
    v_yes_big.style.fill=c_default;
    voted="dislike"
}

if(document.querySelector(".thumbs")){
    setUpVoting()
}

var gstat=document.getElementById("gstat");
if(gstat){
    setTimeout(function(){
        gstat.innerHTML='<img src="/div/g.php?id='+gstat.dataset.id+"&l="+document.documentElement.lang+'" style="display:none;" border="0" height="1" width="1 alt=".">'
    } ,30000)
}


function initScreenshots(){
    var e=document.getElementById("modal");
    const d=document.querySelectorAll(".shot");
    var a=document.getElementById("img01");
    var f=document.getElementById("caption");
    var c=document.querySelector("#wt-iframe");
    for(i=0;i<d.length;i++){
        d[i].onclick=function(h){
            h.preventDefault();
            e.style.display="block";
            a.src=this.dataset.surl;
            a.style.display="block";
            f.innerHTML=this.alt;
            f.style.display="block"
        }
    }
    
    var b=document.getElementsByClassName("close")[0];
    b.onclick=function(){
        e.style.display="none"
    };
    e.onclick=function(){
        a.style.display="none";
        e.style.display="none";
        f.style.display="none";
        c.innerHTML=""
    }
}

if(document.getElementById("modal")){
    initScreenshots()
}

function preventScrolling(){
    document.body.style.overflow="hidden"
}

function activateScrolling(){
    document.body.style.overflow="auto"
}

function loadOwnAds(){
    const c=document.documentElement.lang;
    const a='<iframe src="/div/own.php?pos=r&f=160&l='+c+'" marginwidth="0" marginheight="0" scrolling="no" style="overflow:hidden;margin-left:10px " width="300" height="600"></iframe>';
}

if(g.dataset.device==="desktop"){
    if(adBlockIsEnabled()){
        loadOwnAds()
    }
}else{}

function isMobileDevice(){
    if(navigator.userAgent.match(/iPhone/i)){
        return 1
    }
    
    if(navigator.userAgent.match(/iPad/i)){
        return 1
    }if(navigator.userAgent.match(/Android/i)){
        return 1
    }if(navigator.userAgent.match(/BlackBerry/i)){
        return 1
    }if(navigator.userAgent.match(/Windows Phone/i)){
        return 1
    }return 0
}

if(g&&g.dataset.src.search("gamedistribution")>0){
    if(typeof non_personalized_ads!=="undefined"&&non_personalized_ads===1){
        g.dataset.src=g.dataset.src+"?gdpr-targeting=0&gd_sdk_referrer_url="+document.URL
    }else{
        g.dataset.src=g.dataset.src+"?gdpr-targeting=1&gd_sdk_referrer_url="+document.URL
    }
}

if(adBlockIsEnabled()){

};
